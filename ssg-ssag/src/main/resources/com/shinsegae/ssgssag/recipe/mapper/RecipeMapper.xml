<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shinsegae.ssgssag.recipe.mapper.RecipeMapper">	<!-- 인터페이스 -->

<!-- 등록 -->
<insert id="recipeInsert" parameterType="com.shinsegae.ssgssag.recipe.vo.RecipeVO">
	INSERT INTO recipe (
		recipe_id
	) VALUES (
		#{recipe_id}
	)
</insert>

<!-- 조회 -->
<select id="selectList" resultType="com.shinsegae.ssgssag.recipe.vo.RecipeVO">
	SELECT r.recipe_id, recipe_name, recipe_img, source, level, <!-- recipe_ing_info, -->
	IFNULL(COUNT(like_id), 0) AS cnt
	FROM recipe r
	LEFT OUTER JOIN like_recipe l
	ON r.recipe_id = l.recipe_id
	<!-- 검색 조건 -->
	<where>
		<!-- 전체 조회 -->
		<if test="type == 'all'">
			<if test="rname != '' and rname != null">
				AND recipe_name LIKE '%${rname}%'
				|| r.recipe_id IN (
					SELECT recipe_id 
					FROM recipe_ing 
					WHERE ing_id IN (
						SELECT ing_id FROM ingredients WHERE ing_name LIKE '%${rname}%'
					)
				)
			</if>
		</if>
		<!-- 레시피 이름 조회 -->
		<if test="type == 'rcp'">
			<if test="rname != '' and rname != null">
				AND recipe_name LIKE '%${rname}%'
			</if>
		</if>
		<!-- 레시피 재료 조회 -->
		<if test="type == 'ing'">
			<if test="rname != '' and rname != null">
				AND recipe_id IN (
					SELECT recipe_id 
					FROM recipe_ing 
					WHERE ing_id IN (
						SELECT ing_id FROM ingredients WHERE ing_name LIKE '%${rname}%'
					)
				)

			</if>
		</if>
	</where>
	group by recipe_id
	<!-- 정렬 조건 -->
	<if test="sort != null and sort !=''"> ORDER BY
		<choose>
		    <when test="sort == 'name'"> recipe_name </when>
		    <when test="sort == 'level'"> level, recipe_name </when>
		    <when test="sort == 'like'"> cnt DESC, recipe_name </when>
	    </choose>
    </if>
</select>

<select id="getIngs" parameterType="String" resultType="String">
	SELECT ing_name FROM ingredients WHERE ing_id IN (SELECT ing_id FROM recipe_ing WHERE recipe_id = #{a })
</select>

<select id="getSteps" parameterType="String" resultType="String">
	SELECT description FROM recipe_step WHERE recipe_id = #{a }
</select>

</mapper>